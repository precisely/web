BioinformaticsECSCluster:
  Type: AWS::ECS::Cluster
  Properties:
    ClusterName: ${self:custom.vars.bioinformaticsECSClusterName}

# XXX: Instances of AWS::ECS::TaskDefinition below are duplicated with minimal
# naming changes and different commands! This cannot be cleaned up because
# despite what serverless people seem to think, YAML is not flexible enough to
# be a DSL. When changing anything flagged with a COPYPASTA WARNING, be sure you
# know what you're doing and check all other TaskDefinitions carefully if they
# also need updating!

# XXX: COPYPASTA WARNING!
BioinformaticsECSTask: &BioinformaticsECSTask
  Type: AWS::ECS::TaskDefinition
  Properties:
    ExecutionRoleArn:
      Fn::GetAtt: [SystemRole, Arn]
    TaskRoleArn:
      Fn::GetAtt: [SystemRole, Arn]
    Family: ${self:custom.vars.bioinformaticsECSTaskName}-Base
    NetworkMode: awsvpc
    Cpu: 4096
    Memory: 20480
    ContainerDefinitions:
      - Name: ${self:custom.vars.bioinformaticsECSContainerName}-Base
        Image: 416000760642.dkr.ecr.us-east-1.amazonaws.com/dev/precisely-bioinformatics:latest
        Environment:
          - Name: AWS_S3_ENDPOINT_URL
            Value: https://s3.amazonaws.com
          - Name: S3_BUCKET_BIOINFORMATICS_UPLOAD
            Value: ${self:custom.vars.bioinformaticsUploadBucket}
          - Name: S3_BUCKET_BIOINFORMATICS_VCF
            Value: ${self:custom.vars.bioinformaticsVCFBucket}
          - Name: S3_BUCKET_BIOINFORMATICS_ERROR
            Value: ${self:custom.vars.bioinformaticsErrorBucket}
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: BioinformaticsECSLogs
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: ${self:provider.stage}-ecs-bioinformatics
    RequiresCompatibilities:
      - FARGATE

# XXX: COPYPASTA WARNING!
BioinformaticsECSTaskUpdateAllUsersCallVariants:
  Type: AWS::ECS::TaskDefinition
  Properties:
    ExecutionRoleArn:
      Fn::GetAtt: [SystemRole, Arn]
    TaskRoleArn:
      Fn::GetAtt: [SystemRole, Arn]
    Family: ${self:custom.vars.bioinformaticsECSTaskName}-UpdateAllUsersCallVariants
    NetworkMode: awsvpc
    Cpu: 512
    Memory: 2048
    ContainerDefinitions:
      - Name: ${self:custom.vars.bioinformaticsECSContainerName}-UpdateAllUsersCallVariants
        Image: 416000760642.dkr.ecr.us-east-1.amazonaws.com/dev/precisely-bioinformatics:latest
        Environment:
          - Name: AWS_S3_ENDPOINT_URL
            Value: https://s3.amazonaws.com
          - Name: S3_BUCKET_BIOINFORMATICS_UPLOAD
            Value: ${self:custom.vars.bioinformaticsUploadBucket}
          - Name: S3_BUCKET_BIOINFORMATICS_VCF
            Value: ${self:custom.vars.bioinformaticsVCFBucket}
          - Name: S3_BUCKET_BIOINFORMATICS_ERROR
            Value: ${self:custom.vars.bioinformaticsErrorBucket}
        Command:
          - /bin/bash
          - -c
          - /precisely/app/run-remote-access.sh && /precisely/app/run-update.sh --data-source=23andme --stage=${self:provider.stage} --test-mock-lambda=false --cleanup-after=true
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group:
              Ref: BioinformaticsECSLogs
            awslogs-region:
              Ref: AWS::Region
            awslogs-stream-prefix: ${self:provider.stage}-ecs-bioinformatics
    RequiresCompatibilities:
      - FARGATE

# XXX: This is configured, but currently adds no value. First, we do not have
# multiple tasks which need to execute together as a "service". Second, more
# seriously, see the AwsvpcConfiguration down there? One might expect it to
# provide reasonable defaults for tasks bound to this service, but it does no
# such thing. Running `aws ecs run-task` _requires_ this information to be
# passed in at runtime no matter what is configured here.
BioinformaticsECSService:
  Type: AWS::ECS::Service
  Properties:
    Cluster:
      Ref: BioinformaticsECSCluster
    ServiceName: ${self:provider.stage}-BioinformaticsECSService
    TaskDefinition:
      Ref: BioinformaticsECSTask
    DesiredCount: 0
    LaunchType: FARGATE
    NetworkConfiguration:
      AwsvpcConfiguration:
        AssignPublicIp: ENABLED
        Subnets:
          - ${self:custom.vars.subnetId}
        SecurityGroups:
          - ${self:custom.vars.securityGroupIdAllowInboundSSH}

BioinformaticsMetricFilterErrors:
  Type: AWS::Logs::MetricFilter
  Properties:
    LogGroupName:
      Ref: BioinformaticsECSLogs
    FilterPattern: '{$.level="error"}'
    MetricTransformations:
      - MetricValue: 1
        MetricNamespace: Bioinformatics/Tasks
        MetricName: ${self:provider.stage}-TaskErrorCount

BioinformaticsAlarm:
  Type: AWS::CloudWatch::Alarm
  Properties:
    AlarmDescription: Bioinformatics task error alert
    Namespace: Bioinformatics/Tasks
    MetricName: ${self:provider.stage}-TaskErrorCount
    Statistic: Sum
    Period: 60
    EvaluationPeriods: 1
    Threshold: 0
    ComparisonOperator: GreaterThanThreshold
    TreatMissingData: notBreaching
    AlarmActions:
      - Ref: TopicErrorNotification

# XXX: This is completely broken because of the EcsParameters problem below.
# The workaround is to run the BioinformaticsUpdateAllUsersCallVariants Lambda
# on the same schedule.
# BioinformaticsRuleUpdateAllUsersCallVariants:
#   Type: AWS::Events::Rule
#   Properties:
#     Description: Update Dynamo call variants for all users
#     # XXX: Do NOT specify a Name, documentation claims that updates would then require name replacement!
#     #Name: ${self:provider.stage}-BioinformaticsUpdateAllUsersCallVariants
#     # run every hour, change first 0 to 0/15 for every 15min
#     ScheduleExpression: cron(0 * * * ? *)
#     State: ENABLED
#     Targets:
#       - Id: ${self:provider.stage}-BioinformaticsUpdateAllUsersCallVariants
#         RoleArn:
#           Fn::GetAtt: [SystemRole, Arn]
#         EcsParameters:
#           # XXX: https://docs.aws.amazon.com/AmazonCloudWatchEvents/latest/APIReference/API_EcsParameters.html
#           # lies. LaunchType and NetworkConfiguration error out on deployment.
#           # https://stackoverflow.com/questions/52208700/ecs-parameters-networkconfiguration-launchtype-not-recognized-for-awseven
#           # LaunchType: FARGATE
#           # NetworkConfiguration:
#           #   awsvpcConfiguration:
#           #     AssignPublicIp: ENABLED
#           #     SecurityGroups:
#           #       - ${self:custom.vars.securityGroupIdAllowInboundSSH}
#           #     Subnets:
#           #       - ${self:custom.vars.subnetId}
#           TaskDefinitionArn:
#             Ref: BioinformaticsECSTaskUpdateAllUsersCallVariants
#           TaskCount: 1
#         Arn:
#           Fn::GetAtt: [BioinformaticsECSCluster, Arn]
