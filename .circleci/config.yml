# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#

defaults: &defaults
    environment:
        CC_TEST_REPORTER_ID: d3c6223bb6beb7b56cc01e2865e445a028085cd455695307b99d521bfcd2e1c8
    docker:
        # specify the version you desire here
        - image: circleci/node:6.10.3

        # Specify service dependencies here if necessary
        # CircleCI maintains a library of pre-built images
        # documented at https://circleci.com/docs/2.0/circleci-images/
        # - image: circleci/mongo:3.4.4

    working_directory: ~/repo

download_codeclimate: &download_codeclimate
    run:
        name: Download Code Climate test-reporter
        command: |
            curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
            chmod +x ./cc-test-reporter

upload_codeclimate_results: &upload_codeclimate_results
    run:
        name: Upload Code Climate Results
        command: |
            ./cc-test-reporter format-coverage --output "coverage/codeclimate.$CIRCLE_JOB.json"
            AWS_REGION=us-east-1 AWS_SECRET_ACCESS_KEY=$CODECLIMATE_AWS_SECRET_ACCESS_KEY AWS_ACCESS_KEY_ID=$CODECLIMATE_AWS_ACCESS_KEY_ID aws s3 sync coverage/ "s3://dev-precisely-codeclimate/coverage/$BUILD_NUMBER"

version: 2
jobs:
    build-frontend:
        <<: *defaults

        steps:
        - checkout

        # Download and cache dependencies
        - restore_cache:
            keys:
            - v1-dependencies-{{ checksum "app-client/package.json" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-

        - run:
            name: Installing Dependencies
            command: cd app-client && yarn install

        - <<: *download_codeclimate

        - save_cache:
            paths:
                - node_modules
                - app-client/node_modules
            key: v1-dependencies-{{ checksum "app-client/package.json" }}

        # run frontend tests!
        - run:
            name: Frontend Tests
            command: |
                cd app-client
                ./cc-test-reporter before-build
                yarn test
                ./cc-test-reporter after-build --debug -t lcov --exit-code $?

        # run linters!
        - run:
            name: TSLint
            command: cd app-client && yarn tslint
        - run:
            name: ESLint
            command: cd app-client && yarn eslint

        - <<: *upload_codeclimate_results

    build-backend:
        <<: *defaults
        steps:
        - checkout

        # Download and cache dependencies
        - restore_cache:
            keys:
            - v1-dependencies-{{ checksum "app-backend/package.json" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-

        - run:
            name: Installing Dependencies
            command: cd app-backend && yarn install

        - save_cache:
            paths:
                - node_modules
                - app-backend/node_modules
            key: v1-dependencies-{{ checksum "app-backend/package.json" }}

        - <<: *download_codeclimate

        # run backend tests!
        - run:
            name: Backend Tests
            command: |
                cd app-backend
                ./cc-test-reporter before-build
                yarn test
                ./cc-test-reporter after-build --debug -t lcov --exit-code $?

        # run linters!
        - run:
            name: TSLint
            command: cd app-backend && yarn tslint
        - run:
            name: ESLint
            command: cd app-backend && yarn eslint

        - <<: *upload_codeclimate_results

    stage-deploy-frontend:
        <<: *defaults
        steps:
            - checkout
            - restore_cache:
                keys:
                - v1-dependencies-{{ checksum "app-client/package.json" }}
                # fallback to using the latest cache if no exact match is found
                - v1-dependencies-
            - run:
                name: Set AWS Profile
                command: cd app-client && ./node_modules/.bin/serverless config credentials --provider aws -n stage-profile-precisely --key ${AWS_ACCESS_KEY_STAGE} --secret ${AWS_SECRET_KEY_STAGE}
            - run:
                name: Deploying frontend on Staging
                command: cd app-client && yarn deploy:stage

    stage-deploy-backend:
        <<: *defaults
        steps:
            - checkout
            - restore_cache:
                keys:
                - v1-dependencies-{{ checksum "app-backend/package.json" }}
                # fallback to using the latest cache if no exact match is found
                - v1-dependencies-
            - run:
                name: Set AWS Profile
                command: cd app-backend && ./node_modules/.bin/serverless config credentials --provider aws -n stage-profile-precisely --key ${AWS_ACCESS_KEY_STAGE} --secret ${AWS_SECRET_KEY_STAGE}
            - run:
                name: Deploying backend on Staging
                command: cd app-backend && yarn deploy:stage

workflows:
    version: 2
    build-test-and-deploy:
        jobs:
            - build-frontend
            - build-backend

            # run this job only when dev branch is build
            - stage-deploy-backend:
                filters:
                    branches:
                        only:
                            - dev
                requires:
                    - build-backend
                    - build-frontend

            - stage-deploy-frontend:
                filters:
                    branches:
                        only:
                            - dev
                requires:
                    - stage-deploy-backend
